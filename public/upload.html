<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VERICERT – Upload Certificate</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0fdfa;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 128, 128, 0.1);
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      border: 1px solid #b2dfdb;
    }

    h2 {
      text-align: center;
      color: #003333;
      margin-bottom: 25px;
      font-size: 22px;
    }

    .file-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 12px;
      background-color: #e0f2f1;
    }

    .file-row input[type="file"] {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }

    .file-label {
      background-color: #008080;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
      flex-shrink: 0;
    }

    .file-name {
      font-size: 13px;
      color: #003333;
      margin-left: 10px;
      flex-grow: 1;
      text-align: right;
    }

    .upload-btn {
      margin-top: 25px;
      background-color: #008080;
      color: white;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
    }

    .upload-btn:hover {
      background-color: #006666;
    }

    #status, #cidResult {
      margin-top: 20px;
      text-align: center;
      font-size: 14px;
    }

    #status.success {
      color: #00695c;
    }

    #status.error {
      color: #cc0000;
    }

    code {
      background-color: #e0f2f1;
      padding: 6px;
      display: inline-block;
      border-radius: 4px;
      font-size: 13px;
      margin-top: 8px;
    }

    a {
      color: #008080;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Certificate to IPFS</h2>

    <div class="file-row">
      <label for="fileInput" class="file-label">Choose File</label>
      <input type="file" id="fileInput" accept=".pdf" onchange="showFileName()" />
      <span id="fileName" class="file-name">No file chosen</span>
    </div>

    <button class="upload-btn" onclick="uploadToIPFS()">Upload</button>

    <div id="status"></div>
    <div id="cidResult"></div>
  </div>

  <script>
    function showFileName() {
      const fileInput = document.getElementById('fileInput');
      const fileName = document.getElementById('fileName');
      fileName.innerText = fileInput.files.length > 0
        ? fileInput.files[0].name
        : "No file chosen";
    }

    async function uploadToIPFS() {
      const fileInput = document.getElementById('fileInput');
      const status = document.getElementById('status');
      const cidResult = document.getElementById('cidResult');

      if (!fileInput.files.length) {
        alert("Please select a PDF file.");
        return;
      }

      const file = fileInput.files[0];
      status.textContent = "Uploading to IPFS...";
      status.className = "";
      cidResult.innerHTML = "";

      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(',')[1];

        try {
          const response = await fetch('http://localhost:3001/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileBase64: base64 })
          });

          if (!response.ok) {
            status.textContent = "Upload failed. Please check the backend.";
            status.className = "error";
            return;
          }

          const result = await response.json();
          const previousCid = localStorage.getItem("uploadedCid");

          // Duplicate file detection
          if (previousCid === result.cid) {
            status.textContent = "❌ This file has already been uploaded.";
            status.className = "error";
            cidResult.innerHTML = `
              <code>${result.cid}</code><br>
              <a href="https://ipfs.io/ipfs/${result.cid}" target="_blank">View on IPFS</a>
            `;
            return;
          }

          // Success flow
          localStorage.setItem("uploadedCid", result.cid);
          status.textContent = "✅ Upload successful.";
          status.className = "success";

          cidResult.innerHTML = `
            <div>IPFS CID:</div>
            <code>${result.cid}</code><br>
            <a href="https://ipfs.io/ipfs/${result.cid}" target="_blank">View on IPFS</a><br><br>
            <button class="upload-btn" onclick="goToIssue()">Proceed to Issue Certificate</button>
          `;
        } catch (err) {
          status.textContent = "❌ Error: " + err.message;
          status.className = "error";
        }
      };

      reader.readAsDataURL(file);
    }

    function goToIssue() {
      window.location.href = "issue.html";
    }
  </script>
</body>
</html>
